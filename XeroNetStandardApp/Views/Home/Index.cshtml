@model XeroNetStandardApp.Models.HomeIndexViewModel

@{
    ViewData["Title"] = "Connected Organisations";
}

<div class="card shadow-sm">
    <div class="card-body">
        @if (!Model.IsConnected)
        {
            <h5 class="card-title">No Xero organisation connected</h5>
            <p class="card-text">You can connect an organisation to begin loading data.</p>
            <a class="btn btn-primary" href="@Url.Action("Index", "Authorization")">Connect to Xero</a>
        }
        else
        {
            <h5 class="mb-3">Your Xero Organisations</h5>

            @if (Model.Tenants.Count == 0)
            {
                <p class="text-muted">No organisations connected.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Organisation</th>
                                <th>Tenant ID</th>
                                <th>Last Updated</th>
                                <th>Rows Inserted</th>
                                <th colspan="3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var tenant in Model.Tenants)
                            {
                                <tr>
                                    <td>@tenant.OrgName</td>
                                    <td class="text-monospace">@tenant.TenantId</td>
                                    <td class="last-polled" data-tenant="@tenant.TenantId">—</td>
                                    <td class="last-rows" data-tenant="@tenant.TenantId">—</td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-secondary"
                                           asp-controller="DataLoadLogs"
                                           asp-action="Index"
                                           asp-route-tenantId="@tenant.TenantId"
                                           asp-route-orgName="@tenant.OrgName">Logs</a>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-primary"
                                           asp-controller="Authorization"
                                           asp-action="Index">Reauthorise</a>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-danger"
                                           asp-controller="Authorization"
                                           asp-action="Disconnect"
                                           asp-route-tenantId="@tenant.TenantId">Disconnect</a>
                                    </td>
                                </tr>
                            }

                            <tr>
                                <td colspan="4" class="text-muted text-end pe-3">
                                    
                                </td>
                                <td></td>
                                <td>
                                    <a class="btn btn-sm btn-outline-primary"
                                       asp-controller="Authorization"
                                       asp-action="Index">
                                        Add New
                                    </a>
                                </td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script>
        function updateTenantInfo() {
            document.querySelectorAll('.last-polled').forEach(function (cell) {
                const tid = cell.dataset.tenant;
                const val = localStorage.getItem('pollLast_' + tid);
                const date = val ? new Date(parseInt(val, 10)) : null;
                cell.textContent = date && !isNaN(date) ? date.toLocaleString() : 'Not updated yet';
            });

            document.querySelectorAll('.last-rows').forEach(function (cell) {
                const tid = cell.dataset.tenant;
                const val = localStorage.getItem('pollRows_' + tid);
                const rows = parseInt(val, 10);
                cell.textContent = !isNaN(rows) ? rows : '—';
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateTenantInfo);
        } else {
            updateTenantInfo();
        }
    </script>
}
